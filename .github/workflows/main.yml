
name: CI/CD Pipeline

on:
  workflow_dispatch: {}

permissions:
  contents: read

env:
  # Change these
  ACR_NAME:  satishacr12345        # e.g. satishacr12345 (must be lowercase & globally unique)
  RESOURCE_GROUP: rg-python-cicd     # e.g. rg-python-cicd
  LOCATION: eastus-1                     # choose your Azure region
  IMAGE_NAME: python-cicd               # this becomes the ACR "repository" name

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

  docker_acr:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1) Login to Azure (Service Principal JSON stored in GitHub Secrets)
      - name: AzureLogin
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 2) Ensure resource group exists (idempotent)
      - name: Ensure Resource Group exists
        run: |
          az group create \
            --name "${{ env.RESOURCE_GROUP }}" \
            --location "${{ env.LOCATION }}"

      # 3) Ensure ACR exists (create if missing)
      - name: Ensure ACR exists
        run: |
          set -e
          if az acr show --name "${{ env.ACR_NAME }}" --resource-group "${{ env.RESOURCE_GROUP }}" >/dev/null 2>&1; then
            echo "ACR already exists: ${{ env.ACR_NAME }}"
          else
            echo "Creating ACR: ${{ env.ACR_NAME }}"
            az acr create \
              --name "${{ env.ACR_NAME }}" \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --sku Basic
          fi

      # 4) Login Docker to ACR (recommended via Azure CLI) [2](https://learn.microsoft.com/en-us/azure/container-registry/container-registry-get-started-docker-cli)
      - name: Login to ACR
        run: |
          az acr login --name "${{ env.ACR_NAME }}"

      # 5) Get login server, build & push image
      - name: Build and Push Docker Image to ACR
        run: |
          LOGIN_SERVER=$(az acr show --name "${{ env.ACR_NAME }}" --query loginServer -o tsv)
          IMAGE="${LOGIN_SERVER}/${{ env.IMAGE_NAME }}"
          TAG="${{ github.sha }}"

          echo "Pushing: ${IMAGE}:${TAG}"
          docker build -t "${IMAGE}:${TAG}" -t "${IMAGE}:latest" .
          docker push "${IMAGE}:${TAG}"
          docker push "${IMAGE}:latest"
